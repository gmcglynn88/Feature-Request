<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --error-color:#dc2626; --success-color:#16a34a;
    }
    body{font-family:"Aptos","Segoe UI",Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,textarea,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px;font-family:inherit}
    textarea{min-height:100px;resize:vertical}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .form-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:20px;width:100%}
    .form-field{margin-bottom:0;width:100%}
    .form-field.full-width{grid-column:1/-1;width:100%;margin-top:20px}
    .required:after{content:" *";color:var(--error-color)}
    .error{color:var(--error-color);font-size:12px;margin-top:4px;min-height:16px}
    .success-message{background-color:#f0fdf4;border:1px solid var(--success-color);border-radius:8px;padding:20px;text-align:center;margin:20px 0}
    .success-message h3{color:var(--success-color);margin:0 0 8px}
    .auth-section{text-align:center;padding:40px 20px}
    .auth-btn{background:var(--primary-color);color:#fff;padding:12px 24px;font-size:16px;font-weight:600;border:none;border-radius:8px;cursor:pointer}
    .auth-btn:hover{background:var(--secondary-color)}
    .hidden{display:none}
    
    /* Info list with ticks */
    .info-list{list-style:none;margin-top:16px}
    .info-list li{padding:8px 0;padding-left:24px;position:relative;color:var(--text-light)}
    .info-list li::before{content:"âœ“";position:absolute;left:0;color:var(--primary-color);font-weight:bold}
    
    /* Submitted requests table */
    .requests-table{width:100%;border-collapse:collapse;margin-top:16px}
    .requests-table th,.requests-table td{border:1px solid var(--border-color);padding:12px;text-align:left}
    .requests-table th{background-color:var(--primary-color);color:white;font-weight:600}
    .requests-table tr:nth-child(even){background-color:var(--light-bg)}
    .requests-table tr:hover{background-color:#f0f7f4}
    
    /* Tab styling */
    .tab-container{margin-top:20px}
    .tab-buttons{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:20px}
    .tab-button{padding:10px 20px;background:none;border:none;cursor:pointer;font-weight:600;color:var(--text-light);border-bottom:3px solid transparent;transition:all .2s}
    .tab-button.active{color:var(--primary-color);border-bottom-color:var(--primary-color)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    /* Make textareas stretch to full width */
    textarea{width:100%;box-sizing:border-box}
    #useCase, #supportingInfo{min-height:100px;width:100%;resize:vertical;box-sizing:border-box}
    
    /* Ensure form fields within full-width containers stretch properly */
    .form-field.full-width textarea,
    .form-field.full-width input {
        width: 100%;
        box-sizing: border-box;
    }
    
    @media (max-width: 1200px) {
      .form-grid{grid-template-columns:repeat(3,1fr)}
    }
    @media (max-width: 768px) {
      .form-grid{grid-template-columns:1fr}
      .form-field.full-width{grid-column:1/-1}
    }
  </style>
</head>
<body>
  <div id="authSection" class="card auth-section">
    <p style="margin-bottom:20px;color:var(--text-light)">Please authenticate with Genesys Cloud to submit a feature request</p>
    <button id="signinBtn" class="auth-btn">Sign in to Genesys Cloud</button>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="submit">Submit Request</button>
        <button class="tab-button" data-tab="view">View My Requests</button>
      </div>
      
      <!-- Submit Request Tab -->
      <div id="submit-tab" class="tab-content active">
        <div class="card">
          <h1 style="margin:0 0 8px;">Feature Request Form</h1>
          <p class="muted" style="margin-bottom:20px">Submit your request for new features, enhancements, or applications</p>
          
          <form id="featureRequestForm">
            <!-- Compact 5-column grid for top row -->
            <div class="form-grid">
              <div class="form-field">
                <label for="name" class="required">Name</label>
                <input type="text" id="name" name="name" required placeholder="Full name">
                <div id="nameError" class="error hidden"></div>
              </div>
              
              <div class="form-field">
                <label for="role" class="required">Role</label>
                <input type="text" id="role" name="role" required placeholder="Role">
                <div id="roleError" class="error hidden"></div>
              </div>
              
              <div class="form-field">
                <label for="company" class="required">Company</label>
                <input type="text" id="company" name="company" required placeholder="Company">
                <div id="companyError" class="error hidden"></div>
              </div>
              
              <div class="form-field">
                <label for="appRequestType" class="required">Request Type</label>
                <select id="appRequestType" name="appRequestType" required>
                  <option value="">Select type</option>
                  <option value="Existing App Enhancement">Existing App Enhancement</option>
                  <option value="Reporting & Analytics">Reporting & Analytics</option>
                  <option value="Data Extraction">Data Extraction</option>
                  <option value="Administration App">Administration App</option>
                  <option value="Other">Other</option>
                </select>
                <div id="appRequestTypeError" class="error hidden"></div>
              </div>
              
              <div class="form-field">
                <label for="csmName" class="required">CSM</label>
                <select id="csmName" name="csmName" required>
                  <option value="">Select CSM</option>
                  <option value="Beccy Hunt">Beccy Hunt</option>
                  <option value="Dawn Poustie">Dawn Poustie</option>
                  <option value="Vicki Coleman">Vicki Coleman</option>
                </select>
                <div id="csmNameError" class="error hidden"></div>
              </div>
            </div>
            
            <!-- Other type field (appears below when "Other" is selected) -->
            <div class="form-field full-width hidden" id="otherTypeField">
              <label for="otherType" class="required">Specify Request Type</label>
              <input type="text" id="otherType" name="otherType" placeholder="Please specify your request type">
              <div id="otherTypeError" class="error hidden"></div>
            </div>
            
            <!-- Full width Use Case - STRETCHED -->
            <div class="form-field full-width" style="margin-top:20px">
              <label for="useCase" class="required">Use Case</label>
              <textarea id="useCase" name="useCase" required 
                        placeholder="Please describe your use case in detail. Include information about what you're trying to achieve, who will use it, and how it will benefit your team."></textarea>
              <div id="useCaseError" class="error hidden"></div>
            </div>
            
            <!-- Full width Supporting Information - STRETCHED -->
            <div class="form-field full-width" style="margin-top:20px">
              <label for="supportingInfo">Supporting Information</label>
              <textarea id="supportingInfo" name="supportingInfo" 
                        placeholder="Any additional information, links, screenshots descriptions, or context that might help us understand your request better."></textarea>
            </div>
            
            <div id="formSuccess" class="success-message hidden">
              <h3>âœ… Request Submitted Successfully!</h3>
              <p>Your feature request has been submitted to the Feedback Loop application.</p>
              <p>You will receive updates on the status of your request.</p>
              <button type="button" onclick="resetForm()" style="margin-top:12px">Submit Another Request</button>
            </div>
            
            <div id="formError" class="error hidden" style="margin-bottom:16px;padding:12px;background-color:#fee;border-radius:6px;"></div>
            
            <button type="submit" class="full-width-btn" id="submitBtn">Submit Feature Request</button>
          </form>
        </div>
        
        <div class="card" style="margin-top:20px;">
          <h3 style="margin:0 0 12px;">About This Form</h3>
          <p>This form is used to submit requests for new features, enhancements, or applications within the IPI ecosystem.</p>
          <ul class="info-list">
            <li>All requests are reviewed by the IPI development team</li>
            <li>You will receive updates on the status of your request via email</li>
            <li>Your Customer Success Manager will be notified of your request</li>
            <li>Requests are prioritized based on business impact and feasibility</li>
          </ul>
        </div>
      </div>
      
      <!-- View Requests Tab -->
      <div id="view-tab" class="tab-content">
        <div class="card">
          <h2 style="margin:0 0 12px;">My Submitted Requests</h2>
          <p class="muted">View and track the status of your feature requests</p>
          
          <div id="noRequestsMessage" style="display:none; text-align:center; padding:40px;">
            <div style="font-size:48px;margin-bottom:12px">ðŸ“­</div>
            <div>You haven't submitted any feature requests yet.</div>
            <p class="muted" style="margin-top:8px">Submit your first request using the "Submit Request" tab.</p>
          </div>
          
          <div id="requestsTableContainer" style="overflow-x:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config (Ireland) =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: window.location.origin + window.location.pathname,
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // ===== State =====
    const state = { 
      token: null,
      user: null
    };

    // ===== DOM Elements =====
    const $ = id => document.getElementById(id);
    
    // ===== Auth Functions =====
    function parseTokenFromHash(){
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { 
        token: params.get('access_token'), 
        error: params.get('error'), 
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }
    
    function authUrl(){
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    
    function initAuth(){
      console.log('Initializing authentication...');
      
      const {token, error, errorDescription, expiresIn} = parseTokenFromHash();
      
      // Clear hash from URL
      if(location.hash) {
        history.replaceState(null, '', location.pathname + location.search);
      }

      if(token){
        console.log('Token received via OAuth redirect');
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token; 
        
        // Store token in sessionStorage for persistence
        sessionStorage.setItem('gc_token', token);
        if (expiresIn) {
          const expiryTime = Date.now() + (parseInt(expiresIn) * 1000);
          sessionStorage.setItem('gc_token_expiry', expiryTime.toString());
        }
        
        showMain();
        fetchUserInfo();
        loadUserRequests();
        return;
      }

      // Check if we have a stored token
      const storedToken = sessionStorage.getItem('gc_token');
      const storedExpiry = sessionStorage.getItem('gc_token_expiry');
      
      if (storedToken && storedExpiry && Date.now() < parseInt(storedExpiry)) {
        console.log('Using stored token');
        state.token = storedToken;
        showMain();
        fetchUserInfo();
        loadUserRequests();
        return;
      }

      // Clear expired token
      if (storedToken) {
        sessionStorage.removeItem('gc_token');
        sessionStorage.removeItem('gc_token_expiry');
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if(!attempted && !error){
        console.log('No stored token, attempting auto-auth');
        sessionStorage.setItem('gc_auto_auth_attempted','1');
        location.assign(authUrl());
        return;
      }

      if (error) {
        console.error('OAuth error:', error, errorDescription);
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { 
        sessionStorage.setItem('gc_auto_auth_attempted','1'); 
        location.assign(authUrl()); 
      };
    }

    function showMain(){
      $('authSection').style.display = 'none';
      $('mainContent').style.display = 'block';
    }

    // ===== API Helper =====
    async function api(path){
      if(!state.token) throw new Error('Not authenticated');
      const res = await fetch(`${CONFIG.apiHost}${path}`, { 
        headers:{
          Authorization:`Bearer ${state.token}`,
          'Content-Type': 'application/json'
        } 
      });
      if(res.status===401||res.status===403) {
        // Token expired, clear and retry auth
        sessionStorage.removeItem('gc_token');
        sessionStorage.removeItem('gc_token_expiry');
        sessionStorage.removeItem('gc_auto_auth_attempted');
        location.reload();
        throw new Error(`Authentication error (${res.status}). Please refresh.`);
      }
      if(!res.ok){ 
        const t = await res.text().catch(()=> ''); 
        throw new Error(`API Error: ${res.status} ${res.statusText}${t?` - ${t.slice(0,200)}`:''}`); 
      }
      return res.json();
    }

    // ===== Fetch User Info =====
    async function fetchUserInfo(){
      try {
        const userInfo = await api('/api/v2/users/me');
        state.user = userInfo;
        
        // Pre-fill form with user info if available
        if (userInfo.name) {
          $('name').value = userInfo.name;
        }
        if (userInfo.email) {
          // Extract company from email or set placeholder
          const emailDomain = userInfo.email.split('@')[1];
          if (emailDomain) {
            const companyName = emailDomain.split('.')[0];
            $('company').value = companyName.charAt(0).toUpperCase() + companyName.slice(1);
          }
        }
      } catch (error) {
        console.warn('Could not fetch user info:', error);
      }
    }

    // ===== Tab Management =====
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to clicked button
          button.classList.add('active');
          
          // Show corresponding content
          const tabId = button.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
          
          // If switching to view tab, refresh the requests
          if (button.getAttribute('data-tab') === 'view') {
            loadUserRequests();
          }
        });
      });
    }

    // ===== Form Handling =====
    function setupForm() {
      // Show/hide other type field
      $('appRequestType').addEventListener('change', function() {
        if (this.value === 'Other') {
          $('otherTypeField').classList.remove('hidden');
          $('otherType').required = true;
        } else {
          $('otherTypeField').classList.add('hidden');
          $('otherType').required = false;
          $('otherType').value = '';
        }
      });

      // Form submission
      $('featureRequestForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Hide previous errors and success message
        hideAllErrors();
        $('formError').classList.add('hidden');
        $('formSuccess').classList.add('hidden');
        
        // Validate form
        if (!validateForm()) {
          return;
        }
        
        // Prepare data for submission
        const formData = {
          name: $('name').value.trim(),
          role: $('role').value.trim(),
          company: $('company').value.trim(),
          appRequestType: $('appRequestType').value,
          useCase: $('useCase').value.trim(),
          csmName: $('csmName').value,
          supportingInfo: $('supportingInfo').value.trim(),
          submittedBy: state.user ? state.user.name : 'Unknown',
          submittedByEmail: state.user ? state.user.email : 'Unknown',
          submittedAt: new Date().toISOString(),
          status: 'Under Review',  // Set to 'Under Review'
          priority: 'Medium'
        };
        
        // If "Other" is selected, include the custom type
        if (formData.appRequestType === 'Other') {
          formData.appRequestType = `Other: ${$('otherType').value.trim()}`;
        }
        
        // Submit to Feedback Loop (simulated - replace with actual API call)
        try {
          await submitToFeedbackLoop(formData);
          
          // Show success message
          $('formSuccess').classList.remove('hidden');
          $('featureRequestForm').reset();
          $('otherTypeField').classList.add('hidden');
          $('otherType').required = false;
          
          // Restore user info if available
          if (state.user && state.user.name) {
            $('name').value = state.user.name;
          }
          
          // Refresh the view requests tab
          loadUserRequests();
          
          // Scroll to success message
          $('formSuccess').scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          console.error('Submission error:', error);
          $('formError').textContent = `Failed to submit request: ${error.message}. Please try again or contact support.`;
          $('formError').classList.remove('hidden');
        }
      });
    }

    function validateForm() {
      let isValid = true;
      
      // Name validation
      if (!$('name').value.trim()) {
        showError('nameError', 'Name is required');
        isValid = false;
      }
      
      // Role validation
      if (!$('role').value.trim()) {
        showError('roleError', 'Role is required');
        isValid = false;
      }
      
      // Company validation
      if (!$('company').value.trim()) {
        showError('companyError', 'Company is required');
        isValid = false;
      }
      
      // App Request Type validation
      if (!$('appRequestType').value) {
        showError('appRequestTypeError', 'Please select a request type');
        isValid = false;
      }
      
      // Other Type validation (if applicable)
      if ($('appRequestType').value === 'Other' && !$('otherType').value.trim()) {
        showError('otherTypeError', 'Please specify your request type');
        isValid = false;
      }
      
      // Use Case validation
      if (!$('useCase').value.trim()) {
        showError('useCaseError', 'Use case is required');
        isValid = false;
      } else if ($('useCase').value.trim().length < 20) {
        showError('useCaseError', 'Please provide a more detailed use case (minimum 20 characters)');
        isValid = false;
      }
      
      // CSM validation
      if (!$('csmName').value) {
        showError('csmNameError', 'Please select a Customer Success Manager');
        isValid = false;
      }
      
      return isValid;
    }

    function showError(elementId, message) {
      const element = $(elementId);
      element.textContent = message;
      element.classList.remove('hidden');
    }

    function hideAllErrors() {
      const errorElements = document.querySelectorAll('.error');
      errorElements.forEach(el => {
        el.classList.add('hidden');
        el.textContent = '';
      });
    }

    function resetForm() {
      $('featureRequestForm').reset();
      $('otherTypeField').classList.add('hidden');
      $('otherType').required = false;
      $('formSuccess').classList.add('hidden');
      $('formError').classList.add('hidden');
      hideAllErrors();
      
      // Restore user info if available
      if (state.user && state.user.name) {
        $('name').value = state.user.name;
      }
    }

    // ===== Submit to Feedback Loop =====
    async function submitToFeedbackLoop(formData) {
      console.log('Submitting to Feedback Loop:', formData);
      
      // Generate a unique ID for this request
      const requestId = 'FR-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
      
      // Add metadata with 'Under Review' status
      const submission = {
        id: requestId,
        ...formData,
        submittedAt: new Date().toISOString(),
        status: 'Under Review',  // Changed from 'New' to 'Under Review'
        priority: 'Medium',
        assignedTo: 'IPI Development Team'
      };
      
      // Store in localStorage
      const existingRequests = JSON.parse(localStorage.getItem('ipi_feature_requests') || '[]');
      existingRequests.push(submission);
      localStorage.setItem('ipi_feature_requests', JSON.stringify(existingRequests));
      
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      return {
        success: true,
        requestId: requestId,
        message: 'Request submitted successfully'
      };
    }

    // ===== Load User Requests =====
    function loadUserRequests() {
      const allRequests = JSON.parse(localStorage.getItem('ipi_feature_requests') || '[]');
      
      // Filter requests by current user's email if available
      let userRequests = allRequests;
      if (state.user && state.user.email) {
        userRequests = allRequests.filter(request => 
          request.submittedByEmail === state.user.email
        );
      }
      
      const container = $('#requestsTableContainer');
      const noRequestsMsg = $('#noRequestsMessage');
      
      if (userRequests.length === 0) {
        container.innerHTML = '';
        noRequestsMsg.style.display = 'block';
        return;
      }
      
      noRequestsMsg.style.display = 'none';
      
      // Sort by date, newest first
      userRequests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
      
      let html = '<table class="requests-table">';
      html += '<thead><tr>';
      html += '<th>Request ID</th>';
      html += '<th>Type</th>';
      html += '<th>Submitted</th>';
      html += '<th>Status</th>';
      html += '<th>Priority</th>';
      html += '<th>CSM</th>';
      html += '</tr></thead>';
      html += '<tbody>';
      
      userRequests.forEach(request => {
        const date = new Date(request.submittedAt);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Status badge color
        let statusClass = '';
        switch(request.status) {
          case 'Under Review': statusClass = 'style="background-color:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          case 'In Progress': statusClass = 'style="background-color:#fef3c7;color:#92400e;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          case 'Completed': statusClass = 'style="background-color:#d1fae5;color:#065f46;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          case 'On Hold': statusClass = 'style="background-color:#e5e7eb;color:#374151;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          default: statusClass = 'style="background-color:#e5e7eb;color:#374151;padding:2px 8px;border-radius:12px;font-size:12px"';
        }
        
        // Priority badge
        let priorityClass = '';
        switch(request.priority) {
          case 'High': priorityClass = 'style="background-color:#fee2e2;color:#b91c1c;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          case 'Medium': priorityClass = 'style="background-color:#fef3c7;color:#92400e;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          case 'Low': priorityClass = 'style="background-color:#d1fae5;color:#065f46;padding:2px 8px;border-radius:12px;font-size:12px"'; break;
          default: priorityClass = 'style="background-color:#e5e7eb;color:#374151;padding:2px 8px;border-radius:12px;font-size:12px"';
        }
        
        html += '<tr>';
        html += `<td><strong>${request.id}</strong></td>`;
        html += `<td>${request.appRequestType}</td>`;
        html += `<td>${formattedDate}</td>`;
        html += `<td><span ${statusClass}>${request.status}</span></td>`;
        html += `<td><span ${priorityClass}>${request.priority}</span></td>`;
        html += `<td>${request.csmName}</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ===== Initialize =====
    document.addEventListener('DOMContentLoaded', function() {
      initAuth();
      setupForm();
      setupTabs();
    });
    
    // Make resetForm available globally
    window.resetForm = resetForm;
  </script>
</body>
</html>
