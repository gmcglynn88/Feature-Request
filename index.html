<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Request Form</title>
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
      --pill: #e9f6f0;
      --error-color: #dc2626;
      --success-color: #16a34a;
    }
    
    body {
      font-family: "Aptos", "Segoe UI", Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 1200px;
      background: var(--light-bg);
      color: var(--text-color);
    }
    
    #logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    
    #logo {
      width: 300px;
    }
    
    h1 {
      margin: 0 0 16px;
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-top: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    select, input, textarea, button {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      font-size: 14px;
      font-family: inherit;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button {
      background: var(--primary-color);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }
    
    button:hover {
      background: var(--secondary-color);
    }
    
    button:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }
    
    .full-width-btn {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      margin-top: 12px;
    }
    
    .muted {
      color: var(--text-light);
    }
    
    .mono {
      font-family: ui-monospace, Consolas, Menlo, monospace;
    }
    
    .loading {
      opacity: .6;
      pointer-events: none;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px 24px;
      margin-bottom: 20px;
    }
    
    .form-field {
      margin-bottom: 16px;
    }
    
    .form-field.full-width {
      grid-column: 1/-1;
    }
    
    .required:after {
      content: " *";
      color: var(--error-color);
    }
    
    .error {
      color: var(--error-color);
      font-size: 14px;
      margin-top: 4px;
    }
    
    .success-message {
      background-color: #f0fdf4;
      border: 1px solid var(--success-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
    }
    
    .success-message h3 {
      color: var(--success-color);
      margin: 0 0 8px;
    }
    
    .auth-section {
      text-align: center;
      padding: 40px 20px;
    }
    
    .auth-btn {
      background: var(--primary-color);
      color: #fff;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .auth-btn:hover {
      background: var(--secondary-color);
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="IPI Logo">
  </div>
  
  <div id="authSection" class="card auth-section">
    <h2>Feature Request Form</h2>
    <p class="muted">Please authenticate with Genesys Cloud to submit a feature request</p>
    <button id="signinBtn" class="auth-btn">Sign in to Genesys Cloud</button>
  </div>

  <div id="mainContent" class="hidden">
    <div class="card">
      <h1>Feature Request Form</h1>
      <p class="muted">Submit your request for new features, enhancements, or applications</p>
      
      <form id="featureRequestForm">
        <div class="form-grid">
          <div class="form-field">
            <label for="name" class="required">Name</label>
            <input type="text" id="name" name="name" required placeholder="Enter your full name">
            <div id="nameError" class="error hidden"></div>
          </div>
          
          <div class="form-field">
            <label for="role" class="required">Role</label>
            <input type="text" id="role" name="role" required placeholder="e.g., Supervisor, Analyst, Manager">
            <div id="roleError" class="error hidden"></div>
          </div>
          
          <div class="form-field">
            <label for="company" class="required">Company</label>
            <input type="text" id="company" name="company" required placeholder="Enter your company name">
            <div id="companyError" class="error hidden"></div>
          </div>
          
          <div class="form-field">
            <label for="appRequestType" class="required">App Request Type</label>
            <select id="appRequestType" name="appRequestType" required>
              <option value="">Select a request type</option>
              <option value="Existing App Enhancement">Existing App Enhancement</option>
              <option value="Reporting & Analytics">Reporting & Analytics</option>
              <option value="Data Extraction">Data Extraction</option>
              <option value="Administration App">Administration App</option>
              <option value="Other">Other</option>
            </select>
            <div id="appRequestTypeError" class="error hidden"></div>
          </div>
          
          <div class="form-field hidden" id="otherTypeField">
            <label for="otherType" class="required">Please specify</label>
            <input type="text" id="otherType" name="otherType" placeholder="Please specify your request type">
            <div id="otherTypeError" class="error hidden"></div>
          </div>
          
          <div class="form-field full-width">
            <label for="useCase" class="required">Use Case</label>
            <textarea id="useCase" name="useCase" required placeholder="Please describe your use case in detail. Include information about what you're trying to achieve, who will use it, and how it will benefit your team."></textarea>
            <div id="useCaseError" class="error hidden"></div>
          </div>
          
          <div class="form-field">
            <label for="csmName" class="required">Customer Success Manager</label>
            <select id="csmName" name="csmName" required>
              <option value="">Select a CSM</option>
              <option value="Beccy Hunt">Beccy Hunt</option>
              <option value="Dawn Poustie">Dawn Poustie</option>
              <option value="Vicki Coleman">Vicki Coleman</option>
            </select>
            <div id="csmNameError" class="error hidden"></div>
          </div>
          
          <div class="form-field full-width">
            <label for="supportingInfo">Supporting Information</label>
            <textarea id="supportingInfo" name="supportingInfo" placeholder="Any additional information, links, screenshots descriptions, or context that might help us understand your request better."></textarea>
          </div>
        </div>
        
        <div id="formSuccess" class="success-message hidden">
          <h3>âœ… Request Submitted Successfully!</h3>
          <p>Your feature request has been submitted to the Feedback Loop application.</p>
          <p>You will receive updates on the status of your request.</p>
          <button type="button" onclick="resetForm()">Submit Another Request</button>
        </div>
        
        <div id="formError" class="error hidden" style="margin-bottom:16px;padding:12px;background-color:#fee;border-radius:6px;"></div>
        
        <button type="submit" class="full-width-btn" id="submitBtn">Submit Feature Request</button>
      </form>
    </div>
    
    <div class="card" style="margin-top:20px;">
      <h3>About This Form</h3>
      <p>This form is used to submit requests for new features, enhancements, or applications within the IPI ecosystem.</p>
      <ul class="muted">
        <li>All requests are reviewed by the IPI development team</li>
        <li>You will receive updates on the status of your request via email</li>
        <li>Your Customer Success Manager will be notified of your request</li>
        <li>Requests are prioritized based on business impact and feasibility</li>
      </ul>
    </div>
  </div>

  <script>
    // ===== Config (Ireland) =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: window.location.origin + window.location.pathname,
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // ===== State =====
    const state = { 
      token: null,
      user: null
    };

    // ===== DOM Elements =====
    const $ = id => document.getElementById(id);
    
    // ===== Auth Functions =====
    function parseTokenFromHash() {
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { 
        token: params.get('access_token'), 
        error: params.get('error'), 
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }
    
    function authUrl() {
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    
    function initAuth() {
      console.log('Initializing authentication...');
      
      const { token, error, errorDescription, expiresIn } = parseTokenFromHash();
      
      // Clear hash from URL
      if (location.hash) {
        history.replaceState(null, '', location.pathname + location.search);
      }

      if (token) {
        console.log('Token received via OAuth redirect');
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token; 
        
        // Store token in sessionStorage for persistence
        sessionStorage.setItem('gc_token', token);
        if (expiresIn) {
          const expiryTime = Date.now() + (parseInt(expiresIn) * 1000);
          sessionStorage.setItem('gc_token_expiry', expiryTime.toString());
        }
        
        showMain();
        fetchUserInfo();
        return;
      }

      // Check if we have a stored token
      const storedToken = sessionStorage.getItem('gc_token');
      const storedExpiry = sessionStorage.getItem('gc_token_expiry');
      
      if (storedToken && storedExpiry && Date.now() < parseInt(storedExpiry)) {
        console.log('Using stored token');
        state.token = storedToken;
        showMain();
        fetchUserInfo();
        return;
      }

      // Clear expired token
      if (storedToken) {
        sessionStorage.removeItem('gc_token');
        sessionStorage.removeItem('gc_token_expiry');
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if (!attempted && !error) {
        console.log('No stored token, attempting auto-auth');
        sessionStorage.setItem('gc_auto_auth_attempted', '1');
        location.assign(authUrl());
        return;
      }

      if (error) {
        console.error('OAuth error:', error, errorDescription);
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { 
        sessionStorage.setItem('gc_auto_auth_attempted', '1'); 
        location.assign(authUrl()); 
      };
    }

    function showMain() {
      $('authSection').classList.add('hidden');
      $('mainContent').classList.remove('hidden');
    }

    // ===== API Helper =====
    async function api(path) {
      if (!state.token) throw new Error('Not authenticated');
      
      const res = await fetch(`${CONFIG.apiHost}${path}`, { 
        headers: {
          Authorization: `Bearer ${state.token}`,
          'Content-Type': 'application/json'
        } 
      });
      
      if (res.status === 401 || res.status === 403) {
        // Token expired, clear and retry auth
        sessionStorage.removeItem('gc_token');
        sessionStorage.removeItem('gc_token_expiry');
        sessionStorage.removeItem('gc_auto_auth_attempted');
        location.reload();
        throw new Error(`Authentication error (${res.status}). Please refresh.`);
      }
      
      if (!res.ok) { 
        const t = await res.text().catch(() => ''); 
        throw new Error(`API Error: ${res.status} ${res.statusText}${t ? ` - ${t.slice(0,200)}` : ''}`); 
      }
      
      return res.json();
    }

    // ===== Fetch User Info =====
    async function fetchUserInfo() {
      try {
        const userInfo = await api('/api/v2/users/me');
        state.user = userInfo;
        
        // Pre-fill form with user info if available
        if (userInfo.name) {
          $('name').value = userInfo.name;
        }
        
        if (userInfo.email) {
          // Extract company from email or set placeholder
          const emailDomain = userInfo.email.split('@')[1];
          if (emailDomain) {
            const companyName = emailDomain.split('.')[0];
            $('company').value = companyName.charAt(0).toUpperCase() + companyName.slice(1);
          }
        }
      } catch (error) {
        console.warn('Could not fetch user info:', error);
      }
    }

    // ===== Form Handling =====
    function setupForm() {
      // Show/hide other type field
      $('appRequestType').addEventListener('change', function() {
        if (this.value === 'Other') {
          $('otherTypeField').classList.remove('hidden');
          $('otherType').required = true;
        } else {
          $('otherTypeField').classList.add('hidden');
          $('otherType').required = false;
          $('otherType').value = '';
        }
      });

      // Form submission
      $('featureRequestForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Hide previous errors and success message
        hideAllErrors();
        $('formError').classList.add('hidden');
        $('formSuccess').classList.add('hidden');
        
        // Validate form
        if (!validateForm()) {
          return;
        }
        
        // Prepare data for submission
        const formData = {
          name: $('name').value.trim(),
          role: $('role').value.trim(),
          company: $('company').value.trim(),
          appRequestType: $('appRequestType').value,
          useCase: $('useCase').value.trim(),
          csmName: $('csmName').value,
          supportingInfo: $('supportingInfo').value.trim(),
          submittedBy: state.user ? state.user.name : 'Unknown',
          submittedByEmail: state.user ? state.user.email : 'Unknown',
          submittedAt: new Date().toISOString(),
          status: 'New',
          priority: 'Medium'
        };
        
        // If "Other" is selected, include the custom type
        if (formData.appRequestType === 'Other') {
          formData.appRequestType = `Other: ${$('otherType').value.trim()}`;
        }
        
        // Submit to Feedback Loop (simulated - replace with actual API call)
        try {
          await submitToFeedbackLoop(formData);
          
          // Show success message
          $('formSuccess').classList.remove('hidden');
          $('featureRequestForm').reset();
          $('otherTypeField').classList.add('hidden');
          $('otherType').required = false;
          
          // Scroll to success message
          $('formSuccess').scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          console.error('Submission error:', error);
          $('formError').textContent = `Failed to submit request: ${error.message}. Please try again or contact support.`;
          $('formError').classList.remove('hidden');
        }
      });
    }

    function validateForm() {
      let isValid = true;
      
      // Name validation
      if (!$('name').value.trim()) {
        showError('nameError', 'Name is required');
        isValid = false;
      }
      
      // Role validation
      if (!$('role').value.trim()) {
        showError('roleError', 'Role is required');
        isValid = false;
      }
      
      // Company validation
      if (!$('company').value.trim()) {
        showError('companyError', 'Company is required');
        isValid = false;
      }
      
      // App Request Type validation
      if (!$('appRequestType').value) {
        showError('appRequestTypeError', 'Please select a request type');
        isValid = false;
      }
      
      // Other Type validation (if applicable)
      if ($('appRequestType').value === 'Other' && !$('otherType').value.trim()) {
        showError('otherTypeError', 'Please specify your request type');
        isValid = false;
      }
      
      // Use Case validation
      if (!$('useCase').value.trim()) {
        showError('useCaseError', 'Use case is required');
        isValid = false;
      } else if ($('useCase').value.trim().length < 20) {
        showError('useCaseError', 'Please provide a more detailed use case (minimum 20 characters)');
        isValid = false;
      }
      
      // CSM validation
      if (!$('csmName').value) {
        showError('csmNameError', 'Please select a Customer Success Manager');
        isValid = false;
      }
      
      return isValid;
    }

    function showError(elementId, message) {
      const element = $(elementId);
      element.textContent = message;
      element.classList.remove('hidden');
    }

    function hideAllErrors() {
      const errorElements = document.querySelectorAll('.error');
      errorElements.forEach(el => {
        el.classList.add('hidden');
        el.textContent = '';
      });
    }

    function resetForm() {
      $('featureRequestForm').reset();
      $('otherTypeField').classList.add('hidden');
      $('otherType').required = false;
      $('formSuccess').classList.add('hidden');
      $('formError').classList.add('hidden');
      hideAllErrors();
      
      // Restore user info if available
      if (state.user && state.user.name) {
        $('name').value = state.user.name;
      }
    }

    // ===== Submit to Feedback Loop (Simulated) =====
    async function submitToFeedbackLoop(formData) {
      // In a real implementation, this would make an API call to your Feedback Loop application
      // For now, we'll simulate the submission and store in localStorage for demo purposes
      
      console.log('Submitting to Feedback Loop:', formData);
      
      // Generate a unique ID for this request
      const requestId = 'REQ-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
      
      // Add metadata
      const submission = {
        id: requestId,
        ...formData,
        submittedAt: new Date().toISOString(),
        status: 'New',
        assignedTo: 'IPI Development Team'
      };
      
      // Store in localStorage (for demo purposes)
      const existingRequests = JSON.parse(localStorage.getItem('ipi_feature_requests') || '[]');
      existingRequests.push(submission);
      localStorage.setItem('ipi_feature_requests', JSON.stringify(existingRequests));
      
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      return {
        success: true,
        requestId: requestId,
        message: 'Request submitted successfully'
      };
    }

    // ===== Initialize =====
    document.addEventListener('DOMContentLoaded', function() {
      initAuth();
      setupForm();
    });
    
    // Make resetForm available globally
    window.resetForm = resetForm;
  </script>
</body>
</html>
